{% extends "base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Edit Document" %}{% endblock %}

{% block content %}
<div class="container-fluid px-0">
    <!-- Header -->
    <div class="editor-header bg-primary text-white py-4 mb-0">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="h2 mb-2 fw-bold">{% trans "Edit Document" %}</h1>
                    <p class="mb-0 opacity-75">
                        <i class="fas fa-file-word me-2"></i>
                        {% trans "Editing:" %} <strong>{{ rfp_file.get_file_name }}</strong>
                    </p>
                </div>
                <div class="col-md-4 text-md-end">
                    <span class="badge bg-white text-primary fs-6 px-3 py-2">
                        <i class="fas fa-edit me-2"></i>{% trans "Rich Text Editor" %}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="container py-4">
        <!-- Debug Alert - Remove in production -->
        <div class="alert alert-info alert-dismissible fade show mb-4" role="alert" id="debug-alert" style="display: none;">
            <strong>Debug Info:</strong>
            Content length: {{ text_content|length }} chars |
            File: {{ rfp_file.get_file_name }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div class="row g-4">
            <!-- Main Editor -->
            <div class="col-12 col-xl-12">
                <div class="card editor-card shadow-lg border-0">
                    <!-- Advanced Toolbar -->
                    <div class="editor-toolbar bg-white border-bottom px-3 py-2">
                        <!-- File Operations -->
                        <div class="toolbar-section mb-2">
                            <div class="btn-group btn-group-sm me-3">
                                <button class="btn btn-outline-primary" onclick="saveDocument()" title="Save">
                                    <i class="fas fa-save me-1"></i> Save
                                </button>
                                <button class="btn btn-outline-primary" onclick="printDocument()" title="Print">
                                    <i class="fas fa-print me-1"></i>
                                </button>
                                <button class="btn btn-outline-primary" onclick="insertPageBreak()" title="Insert Page Break">
                                    <i class="fas fa-file-alt me-1"></i> Page Break
                                </button>
                            </div>
                        </div>

                        <!-- Font Family & Size -->
                        <div class="toolbar-section mb-2">
                            <select class="form-select form-select-sm me-2" style="width: 150px;" id="fontFamily" onchange="applyFontFamily(this.value)">
                                <option value="Arial">Arial</option>
                                <option value="Times New Roman">Times New Roman</option>
                                <option value="Courier New">Courier New</option>
                                <option value="Georgia">Georgia</option>
                                <option value="Verdana">Verdana</option>
                                <option value="Helvetica">Helvetica</option>
                                <option value="Tahoma">Tahoma</option>
                                <option value="Trebuchet MS">Trebuchet MS</option>
                            </select>

                            <select class="form-select form-select-sm me-2" style="width: 80px;" id="fontSize" onchange="applyFontSize(this.value)">
                                <option value="8px">8pt</option>
                                <option value="10px">10pt</option>
                                <option value="12px" selected>12pt</option>
                                <option value="14px">14pt</option>
                                <option value="18px">18pt</option>
                                <option value="24px">24pt</option>
                                <option value="36px">36pt</option>
                            </select>
                        </div>

                        <!-- Text Formatting -->
                        <div class="toolbar-section mb-2">
                            <div class="btn-group btn-group-sm me-2">
                                <button class="btn btn-outline-secondary" onclick="formatText('bold')" title="Bold">
                                    <i class="fas fa-bold"></i>
                                </button>
                                <button class="btn btn-outline-secondary" onclick="formatText('italic')" title="Italic">
                                    <i class="fas fa-italic"></i>
                                </button>
                                <button class="btn btn-outline-secondary" onclick="formatText('underline')" title="Underline">
                                    <i class="fas fa-underline"></i>
                                </button>
                                <button class="btn btn-outline-secondary" onclick="formatText('strikeThrough')" title="Strikethrough">
                                    <i class="fas fa-strikethrough"></i>
                                </button>
                            </div>

                            <div class="btn-group btn-group-sm me-2">
                                <button class="btn btn-outline-secondary" onclick="formatText('justifyLeft')" title="Align Left">
                                    <i class="fas fa-align-left"></i>
                                </button>
                                <button class="btn btn-outline-secondary" onclick="formatText('justifyCenter')" title="Align Center">
                                    <i class="fas fa-align-center"></i>
                                </button>
                                <button class="btn btn-outline-secondary" onclick="formatText('justifyRight')" title="Align Right">
                                    <i class="fas fa-align-right"></i>
                                </button>
                                <button class="btn btn-outline-secondary" onclick="formatText('justifyFull')" title="Justify">
                                    <i class="fas fa-align-justify"></i>
                                </button>
                            </div>

                            <div class="btn-group btn-group-sm me-2">
                                <button class="btn btn-outline-secondary" onclick="formatText('insertUnorderedList')" title="Bullet List">
                                    <i class="fas fa-list-ul"></i>
                                </button>
                                <button class="btn btn-outline-secondary" onclick="formatText('insertOrderedList')" title="Numbered List">
                                    <i class="fas fa-list-ol"></i>
                                </button>
                            </div>

                            <input type="color" class="form-control form-control-color me-2" style="width: 40px; height: 30px;"
                                   id="fontColor" onchange="applyColor('foreColor', this.value)" title="Text Color">

                            <input type="color" class="form-control form-control-color me-2" style="width: 40px; height: 30px;"
                                   id="backgroundColor" onchange="applyColor('backColor', this.value)" title="Background Color">
                        </div>

                        <!-- Insert Tools -->
                        <div class="toolbar-section">
                            <div class="btn-group btn-group-sm me-2">
                                <button class="btn btn-outline-primary" onclick="showTableModal()" title="Insert Table">
                                    <i class="fas fa-table me-1"></i> Table
                                </button>
                                <button class="btn btn-outline-primary" onclick="showImageModal()" title="Insert Image">
                                    <i class="fas fa-image me-1"></i> Image
                                </button>
                                <button class="btn btn-outline-primary" onclick="showLinkModal()" title="Insert Link">
                                    <i class="fas fa-link me-1"></i> Link
                                </button>
                            </div>

                            <div class="btn-group btn-group-sm">
                                <button type="button" class="btn btn-outline-secondary d-none" id="exit-fullscreen-btn" onclick="toggleFullscreen()">
                                    <i class="fas fa-compress me-1"></i>
                                    <span class="d-none d-sm-inline">{% trans "Exit Fullscreen" %}</span>
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="fullscreen-btn" onclick="toggleFullscreen()">
                                    <i class="fas fa-expand me-1"></i>
                                    <span class="d-none d-sm-inline">{% trans "Fullscreen" %}</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Rich Text Editor -->
                    <div class="card-body p-0">
                        <form method="post" id="docx-form">
                            {% csrf_token %}
                            <div
                                id="richTextEditor"
                                class="rich-text-editor"
                                contenteditable="true"
                                style="min-height: 600px; padding: 2rem;"
                            >{{ text_content|safe }}</div>
                            <textarea id="docx_content" name="docx_content" style="display: none;"></textarea>
                        </form>
                    </div>

                    <div class="card-footer bg-white border-0 py-4">
                        <div class="d-flex flex-column flex-lg-row gap-3 align-items-stretch">
                            <button type="submit" form="docx-form" class="btn btn-primary btn-lg flex-fill py-3" onclick="prepareContent()">
                                <i class="fas fa-save me-2"></i>
                                {% trans "Save Document" %}
                            </button>

                            <div class="d-flex flex-column flex-sm-row gap-2 flex-fill">
                                <a href="{% url 'rfp_download_for_edit' rfp_pk=referral.pk file_pk=rfp_file.pk %}"
                                   class="btn btn-success flex-fill py-3">
                                    <i class="fas fa-download me-2"></i>
                                    <span class="d-none d-sm-inline">{% trans "Download" %}</span>
                                    <span class="d-sm-none">{% trans "DL" %}</span>
                                </a>

                                <a href="{% url 'rfp_detail' pk=referral.pk %}"
                                   class="btn btn-outline-secondary flex-fill py-3">
                                    <i class="fas fa-arrow-left me-2"></i>
                                    {% trans "Cancel" %}
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Tools Sidebar -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card border-0">
                    <div class="card-body">
                        <h5 class="mb-3"><i class="fas fa-magic me-2 text-primary"></i>{% trans "Quick Tools" %}</h5>
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <button class="btn btn-outline-primary w-100" onclick="insertHeading(1)">
                                    <i class="fas fa-heading me-2"></i>H1
                                </button>
                            </div>
                            <div class="col-md-3 mb-3">
                                <button class="btn btn-outline-primary w-100" onclick="insertHeading(2)">
                                    <i class="fas fa-heading me-2"></i>H2
                                </button>
                            </div>
                            <div class="col-md-3 mb-3">
                                <button class="btn btn-outline-primary w-100" onclick="insertQuote()">
                                    <i class="fas fa-quote-right me-2"></i>Quote
                                </button>
                            </div>
                            <div class="col-md-3 mb-3">
                                <button class="btn btn-outline-primary w-100" onclick="insertCode()">
                                    <i class="fas fa-code me-2"></i>Code
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Table Creation Modal -->
<div class="modal fade" id="tableModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Insert Table</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-6">
                        <label class="form-label">Rows</label>
                        <input type="number" class="form-control" id="tableRows" value="3" min="1" max="20">
                    </div>
                    <div class="col-6">
                        <label class="form-label">Columns</label>
                        <input type="number" class="form-control" id="tableCols" value="3" min="1" max="10">
                    </div>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="tableHeader" checked>
                    <label class="form-check-label" for="tableHeader">
                        Include header row
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="insertTable()">Insert Table</button>
            </div>
        </div>
    </div>
</div>

<!-- Image Insert Modal -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Insert Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Image URL</label>
                    <input type="url" class="form-control" id="imageUrl" placeholder="https://example.com/image.jpg">
                </div>
                <div class="mb-3">
                    <label class="form-label">Or upload image</label>
                    <input type="file" class="form-control" id="imageUpload" accept="image/*">
                </div>
                <div class="mb-3">
                    <label class="form-label">Width (px)</label>
                    <input type="number" class="form-control" id="imageWidth" value="400">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="insertImage()">Insert Image</button>
            </div>
        </div>
    </div>
</div>

<!-- Link Insert Modal -->
<div class="modal fade" id="linkModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Insert Link</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Link Text</label>
                    <input type="text" class="form-control" id="linkText" placeholder="Click here">
                </div>
                <div class="mb-3">
                    <label class="form-label">URL</label>
                    <input type="url" class="form-control" id="linkUrl" placeholder="https://example.com">
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="linkNewTab" checked>
                    <label class="form-check-label" for="linkNewTab">
                        Open in new tab
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="insertLink()">Insert Link</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const editor = document.getElementById('richTextEditor');
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    const exitFullscreenBtn = document.getElementById('exit-fullscreen-btn');

    // Initialize editor
    initializeEditor();

    function initializeEditor() {
        // Set focus to editor
        editor.focus();

        // Add event listeners for real-time features
        editor.addEventListener('input', handleEditorInput);
        editor.addEventListener('click', handleEditorClick);
        editor.addEventListener('keydown', handleKeyCommands);

        // Enhance existing tables
        enhanceExistingTables();

        console.log('Rich text editor initialized');
    }

    function handleEditorInput() {
        // Auto-save functionality
        autoSaveDraft();

        // Clean up any deprecated font tags
        cleanDeprecatedTags();

        // Enhance any new tables
        enhanceExistingTables();
    }

    function handleEditorClick(e) {
        // Handle table cell selection
        if (e.target.tagName === 'TD' || e.target.tagName === 'TH') {
            highlightTableTools();
        }
    }

    function handleKeyCommands(e) {
        // Handle tab key in tables
        if (e.key === 'Tab' && isInTable()) {
            e.preventDefault();
            handleTabInTable(e.shiftKey);
        }

        // Handle enter key for new paragraphs
        if (e.key === 'Enter' && !e.shiftKey) {
            setTimeout(ensureParagraph, 10);
        }

        // Handle Ctrl+Enter for page break
        if (e.key === 'Enter' && e.ctrlKey) {
            e.preventDefault();
            insertPageBreak();
        }
    }

    // Enhanced existing tables with proper styling
    function enhanceExistingTables() {
        const tables = editor.querySelectorAll('table');
        tables.forEach(table => {
            // Ensure table has proper styling
            if (!table.style.width) {
                table.style.width = '100%';
            }
            table.style.tableLayout = 'fixed';
            table.style.wordWrap = 'break-word';
            table.style.overflowWrap = 'break-word';

            // Enhance table cells
            const cells = table.querySelectorAll('td, th');
            cells.forEach(cell => {
                cell.style.wordBreak = 'break-word';
                cell.style.overflowWrap = 'break-word';
                cell.style.hyphens = 'auto';
                cell.style.verticalAlign = 'top';

                // Ensure minimum width
                if (!cell.style.minWidth) {
                    cell.style.minWidth = '50px';
                }
            });
        });
    }

    // Clean deprecated font tags and replace with modern CSS
    function cleanDeprecatedTags() {
        const fontTags = editor.querySelectorAll('font');
        fontTags.forEach(fontTag => {
            const span = document.createElement('span');

            // Transfer attributes to CSS
            const styles = [];
            if (fontTag.face) {
                styles.push(`font-family: ${fontTag.face}`);
            }
            if (fontTag.size) {
                const sizes = {1: '8px', 2: '10px', 3: '12px', 4: '14px', 5: '18px', 6: '24px', 7: '36px'};
                const fontSize = sizes[fontTag.size] || '12px';
                styles.push(`font-size: ${fontSize}`);
            }
            if (fontTag.color) {
                styles.push(`color: ${fontTag.color}`);
            }

            if (styles.length > 0) {
                span.style.cssText = styles.join('; ');
            }

            // Transfer content
            span.innerHTML = fontTag.innerHTML;

            // Replace the font tag
            fontTag.parentNode.replaceChild(span, fontTag);
        });
    }

    // Fullscreen function with close button
    window.toggleFullscreen = function() {
        const isFullscreen = document.body.classList.contains('fullscreen-mode');

        if (!isFullscreen) {
            // Enter fullscreen
            document.body.classList.add('fullscreen-mode');
            fullscreenBtn.classList.add('d-none');
            exitFullscreenBtn.classList.remove('d-none');

            // Add escape key listener
            document.addEventListener('keydown', handleEscapeKey);
        } else {
            // Exit fullscreen
            document.body.classList.remove('fullscreen-mode');
            fullscreenBtn.classList.remove('d-none');
            exitFullscreenBtn.classList.add('d-none');

            // Remove escape key listener
            document.removeEventListener('keydown', handleEscapeKey);
        }

        // Focus the editor
        editor.focus();
    };

    // Handle escape key to exit fullscreen
    function handleEscapeKey(event) {
        if (event.key === 'Escape') {
            toggleFullscreen();
        }
    }

    // MODERN TEXT FORMATTING - Replaced execCommand with Range/Selection API
    window.formatText = function(command, value = null) {
        const selection = window.getSelection();
        if (selection.rangeCount === 0) return;

        const range = selection.getRangeAt(0);

        try {
            // For basic formatting commands, we'll use CSS styling instead of execCommand
            switch(command) {
                case 'bold':
                    applyStyleToSelection('font-weight', 'bold');
                    break;
                case 'italic':
                    applyStyleToSelection('font-style', 'italic');
                    break;
                case 'underline':
                    applyStyleToSelection('text-decoration', 'underline');
                    break;
                case 'strikeThrough':
                    applyStyleToSelection('text-decoration', 'line-through');
                    break;
                case 'justifyLeft':
                    applyStyleToSelection('text-align', 'left');
                    break;
                case 'justifyCenter':
                    applyStyleToSelection('text-align', 'center');
                    break;
                case 'justifyRight':
                    applyStyleToSelection('text-align', 'right');
                    break;
                case 'justifyFull':
                    applyStyleToSelection('text-align', 'justify');
                    break;
                case 'insertUnorderedList':
                    applyStyleToSelection('list-style-type', 'disc', 'ul');
                    break;
                case 'insertOrderedList':
                    applyStyleToSelection('list-style-type', 'decimal', 'ol');
                    break;
                default:
                    // Fallback to execCommand for other commands
                    document.execCommand(command, false, value);
            }
        } catch (error) {
            console.error('Formatting error:', error);
            // Fallback to execCommand
            document.execCommand(command, false, value);
        }

        editor.focus();
    };

    // Modern style application using Range/Selection API
    function applyStyleToSelection(styleProperty, styleValue, wrapTag = null) {
        const selection = window.getSelection();
        if (selection.rangeCount === 0 || selection.isCollapsed) return;

        const range = selection.getRangeAt(0);

        if (wrapTag) {
            // For lists, use execCommand as it's more reliable
            document.execCommand(wrapTag === 'ul' ? 'insertUnorderedList' : 'insertOrderedList', false, null);
        } else {
            // Apply inline style
            const span = document.createElement('span');
            span.style[styleProperty] = styleValue;

            try {
                range.surroundContents(span);
            } catch (e) {
                // If surroundContents fails, use execCommand as fallback
                document.execCommand('styleWithCSS', false, true);
                switch(styleProperty) {
                    case 'font-weight':
                        document.execCommand('bold', false, null);
                        break;
                    case 'font-style':
                        document.execCommand('italic', false, null);
                        break;
                    case 'text-decoration':
                        if (styleValue === 'underline') {
                            document.execCommand('underline', false, null);
                        } else if (styleValue === 'line-through') {
                            document.execCommand('strikeThrough', false, null);
                        }
                        break;
                }
            }
        }

        editor.focus();
    }

    // Apply font family with modern approach
    window.applyFontFamily = function(fontFamily) {
        applyStyleToSelection('font-family', fontFamily);
    };

    // Apply font size with modern approach
    window.applyFontSize = function(fontSize) {
        applyStyleToSelection('font-size', fontSize);
    };

    // Apply color with modern approach
    window.applyColor = function(type, color) {
        applyStyleToSelection(type === 'foreColor' ? 'color' : 'background-color', color);
    };

    // RELIABLE INSERT TEXT FUNCTION - Uses Range API instead of execCommand
    window.insertText = function(html) {
        const selection = window.getSelection();

        if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);

            // Delete any selected content
            range.deleteContents();

            // Create a temporary container to parse HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;

            // Insert the parsed nodes
            const fragment = document.createDocumentFragment();
            while (tempDiv.firstChild) {
                fragment.appendChild(tempDiv.firstChild);
            }

            range.insertNode(fragment);

            // Move cursor after inserted content
            range.setStartAfter(fragment.lastChild || fragment);
            range.setEndAfter(fragment.lastChild || fragment);
            selection.removeAllRanges();
            selection.addRange(range);
        } else {
            // Fallback: append to end
            editor.innerHTML += html;
        }

        editor.focus();
        // Enhance any new tables
        setTimeout(enhanceExistingTables, 100);
    };

    // Page break functionality
    window.insertPageBreak = function() {
        const pageBreakHTML = '<div class="page-break" contenteditable="false" style="page-break-after: always; border-top: 2px dashed #ccc; margin: 2rem 0; padding: 1rem 0;"></div><p><br></p>';
        insertText(pageBreakHTML);
    };

    // RELIABLE TABLE INSERTION - Fixed to work consistently
    window.showTableModal = function() {
        const modal = new bootstrap.Modal(document.getElementById('tableModal'));
        modal.show();
    };

    window.insertTable = function() {
        const rows = parseInt(document.getElementById('tableRows').value) || 3;
        const cols = parseInt(document.getElementById('tableCols').value) || 3;
        const hasHeader = document.getElementById('tableHeader').checked;

        let tableHTML = `<table style="width: 100%; border-collapse: collapse; margin: 1rem 0; table-layout: fixed; border: 1px solid #ddd;">`;

        if (hasHeader) {
            tableHTML += '<thead><tr>';
            for (let i = 0; i < cols; i++) {
                tableHTML += `<th style="border: 1px solid #ddd; padding: 8px; background: #f8f9fa; font-weight: bold; text-align: left; min-width: 50px;">Header ${i+1}</th>`;
            }
            tableHTML += '</tr></thead>';
        }

        tableHTML += '<tbody>';
        for (let i = 0; i < rows; i++) {
            tableHTML += '<tr>';
            for (let j = 0; j < cols; j++) {
                tableHTML += `<td style="border: 1px solid #ddd; padding: 8px; min-width: 50px; vertical-align: top;">&nbsp;</td>`;
            }
            tableHTML += '</tr>';
        }
        tableHTML += '</tbody></table>';

        // Use our reliable insertText function
        insertText(tableHTML);

        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('tableModal'));
        if (modal) modal.hide();
    };

    // Enhanced image functions
    window.showImageModal = function() {
        const modal = new bootstrap.Modal(document.getElementById('imageModal'));
        modal.show();
    };

    window.insertImage = function() {
        const url = document.getElementById('imageUrl').value;
        const file = document.getElementById('imageUpload').files[0];
        const width = document.getElementById('imageWidth').value;

        if (url) {
            const imgHTML = `<img src="${url}" style="max-width: ${width}px; height: auto; display: block; margin: 1rem auto;" alt="Inserted image">`;
            insertText(imgHTML);
        } else if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const imgHTML = `<img src="${e.target.result}" style="max-width: ${width}px; height: auto; display: block; margin: 1rem auto;" alt="Uploaded image">`;
                insertText(imgHTML);
            };
            reader.readAsDataURL(file);
        } else {
            alert('Please provide either an image URL or upload a file.');
            return;
        }

        const modal = bootstrap.Modal.getInstance(document.getElementById('imageModal'));
        if (modal) modal.hide();

        // Reset form
        document.getElementById('imageUrl').value = '';
        document.getElementById('imageUpload').value = '';
    };

    // Enhanced link functions
    window.showLinkModal = function() {
        const modal = new bootstrap.Modal(document.getElementById('linkModal'));
        modal.show();
    };

    window.insertLink = function() {
        const text = document.getElementById('linkText').value || 'Link';
        const url = document.getElementById('linkUrl').value;
        const newTab = document.getElementById('linkNewTab').checked;

        if (url) {
            const target = newTab ? ' target="_blank"' : '';
            const linkHTML = `<a href="${url}"${target} style="color: #4361ee; text-decoration: underline;">${text}</a>`;
            insertText(linkHTML);
        } else {
            alert('Please enter a URL.');
            return;
        }

        const modal = bootstrap.Modal.getInstance(document.getElementById('linkModal'));
        if (modal) modal.hide();

        // Reset form
        document.getElementById('linkText').value = '';
        document.getElementById('linkUrl').value = '';
    };

    // Enhanced quick tools
    window.insertHeading = function(level) {
        const selection = window.getSelection();
        const text = selection.toString() || `Heading ${level}`;
        insertText(`<h${level} style="font-weight: bold; margin: 1rem 0;">${text}</h${level}>`);
    };

    window.insertQuote = function() {
        const selection = window.getSelection();
        const text = selection.toString() || 'Quote text';
        insertText(`<blockquote style="border-left: 4px solid #4361ee; padding-left: 1rem; margin: 1rem 0; color: #666; font-style: italic;">${text}</blockquote>`);
    };

    window.insertCode = function() {
        const selection = window.getSelection();
        const text = selection.toString() || 'code example';
        insertText(`<code style="background: #f4f4f4; padding: 2px 6px; border-radius: 3px; font-family: 'Courier New', monospace;">${text}</code>`);
    };

    // Utility functions
    function isInTable() {
        let node = window.getSelection().anchorNode;
        while (node) {
            if (node.nodeName === 'TABLE' || node.nodeName === 'TD' || node.nodeName === 'TH') {
                return true;
            }
            node = node.parentNode;
        }
        return false;
    }

    function handleTabInTable(isShift) {
        // Implement tab navigation in tables
        console.log('Tab in table:', isShift ? 'backward' : 'forward');
    }

    function highlightTableTools() {
        // Highlight table editing tools when in table
        console.log('Table cell selected');
    }

    function ensureParagraph() {
        // Ensure proper paragraph structure
        const sel = window.getSelection();
        if (sel.rangeCount > 0) {
            const range = sel.getRangeAt(0);
            const node = range.startContainer;

            // If we're at the end of a line, ensure we're in a paragraph
            if (node.nodeType === 3 && range.startOffset === node.length) {
                const parent = node.parentNode;
                if (parent && parent.nodeName !== 'P' && parent.nodeName !== 'DIV') {
                    document.execCommand('formatBlock', false, 'p');
                }
            }
        }
    }

    // Auto-save functionality
    let autoSaveTimer;
    function autoSaveDraft() {
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(() => {
            const content = editor.innerHTML;
            localStorage.setItem('rich_text_draft_{{ rfp_file.pk }}', content);
            console.log('Draft auto-saved');
        }, 30000);
    }

    // Load draft if exists
    const savedDraft = localStorage.getItem('rich_text_draft_{{ rfp_file.pk }}');
    if (savedDraft && (!editor.innerHTML || editor.innerHTML.trim().length < 50)) {
        editor.innerHTML = savedDraft;
        console.log('Auto-saved draft restored');
        // Enhance tables in loaded content
        setTimeout(enhanceExistingTables, 100);
    }

    // Enhanced content preparation with table optimization
    window.prepareContent = function() {
        // Final cleanup of deprecated tags
        cleanDeprecatedTags();

        // Optimize tables for saving
        optimizeTablesForSave();

        const content = editor.innerHTML;
        document.getElementById('docx_content').value = content;

        console.log('Content prepared for saving:', content.length, 'characters');
        return true;
    };

    // Optimize tables before saving
    function optimizeTablesForSave() {
        const tables = editor.querySelectorAll('table');
        tables.forEach(table => {
            // Ensure consistent styling
            table.style.width = '100%';
            table.style.tableLayout = 'fixed';

            const cells = table.querySelectorAll('td, th');
            cells.forEach(cell => {
                // Ensure content wraps properly
                cell.style.wordBreak = 'break-word';
                cell.style.overflowWrap = 'break-word';

                // Clean up empty cells
                if (!cell.innerHTML.trim() || cell.innerHTML === '<br>') {
                    cell.innerHTML = '&nbsp;';
                }
            });
        });
    }

    // Additional utility functions
    window.saveDocument = function() {
        if (prepareContent()) {
            document.getElementById('docx-form').submit();
        }
    };

    window.printDocument = function() {
        // Prepare content for printing
        cleanDeprecatedTags();
        optimizeTablesForSave();

        const content = editor.innerHTML;
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Print Document</title>
                <style>
                    body {
                        font-family: Arial, sans-serif;
                        margin: 20px;
                        line-height: 1.5;
                    }
                    table {
                        border-collapse: collapse;
                        width: 100%;
                        table-layout: fixed;
                        word-wrap: break-word;
                    }
                    table, th, td {
                        border: 1px solid #ddd;
                        padding: 8px;
                        word-break: break-word;
                    }
                    th {
                        background-color: #f2f2f2;
                        font-weight: bold;
                    }
                    img {
                        max-width: 100%;
                        height: auto;
                    }
                    .page-break {
                        page-break-after: always;
                        border-top: 2px dashed #ccc;
                        margin: 2rem 0;
                        padding: 1rem 0;
                        text-align: center;
                    }
                    @media print {
                        table {
                            page-break-inside: avoid;
                        }
                    }
                </style>
            </head>
            <body>${content}</body>
            </html>
        `);
        printWindow.document.close();
        printWindow.print();
    };

    // Handle page refresh warning
    let hasUnsavedChanges = false;
    editor.addEventListener('input', function() {
        hasUnsavedChanges = true;
    });

    window.addEventListener('beforeunload', function(e) {
        if (hasUnsavedChanges) {
            e.preventDefault();
            e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
            return e.returnValue;
        }
    });

    // Clear unsaved changes flag on form submit
    document.getElementById('docx-form').addEventListener('submit', function() {
        hasUnsavedChanges = false;
        localStorage.removeItem('rich_text_draft_{{ rfp_file.pk }}');
    });
});
</script>

<style>
/* Fullscreen mode styles */
body.fullscreen-mode {
    margin: 0;
    padding: 0;
    overflow: hidden;
}

body.fullscreen-mode .container-fluid {
    height: 100vh;
    margin: 0;
    padding: 0;
}

body.fullscreen-mode .editor-card {
    height: 100vh;
    margin: 0;
    border-radius: 0;
}

body.fullscreen-mode .rich-text-editor {
    min-height: calc(100vh - 200px) !important;
    max-height: calc(100vh - 200px);
    overflow-y: auto;
}

/* Table styling */
table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
    margin: 1rem 0;
}

td, th {
    border: 1px solid #ddd;
    padding: 8px;
    word-break: break-word;
    overflow-wrap: break-word;
    min-width: 50px;
    vertical-align: top;
}

th {
    background-color: #f8f9fa;
    font-weight: bold;
}

/* Page break styling */
.page-break {
    page-break-after: always;
    border-top: 2px dashed #ccc;
    margin: 2rem 0;
    padding: 1rem 0;
    text-align: center;
}
</style>
{% endblock %}