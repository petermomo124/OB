{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="page-container">
    <div class="greeting-message-container">
        <h1 class="greeting-heading">Welcome, {{ user.first_name }} {{ user.last_name }}!</h1>
        <p class="greeting-subheading">Your dashboard at a glance.</p>
    </div>

    <div class="stat-container">
        <h2 class="stats-heading">Dashboard</h2>
        <div class="flex-boxes-wrapper">
            {% if user.role == 'admin' or user.role == 'staff' %}
                <div class="stat-box tasks-box">
                    <span class="emoji">‚úÖ</span>
                    <div class="stat-content">
                        <span class="stat-number">{{ total_tasks }}</span>
                        <span class="stat-label">Total Tasks</span>
                    </div>
                </div>
            {% endif %}

            {% if user.role == 'admin' %}
                <div class="stat-box all-users-box">
                    <span class="emoji">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</span>
                    <div class="stat-content">
                        <span class="stat-number">{{ total_users }}</span>
                        <span class="stat-label">Total Users</span>
                    </div>
                </div>

                <div class="stat-box clients-box">
                    <span class="emoji">ü§ù</span>
                    <div class="stat-content">
                        <span class="stat-number">{{ total_clients }}</span>
                        <span class="stat-label">Total Clients</span>
                    </div>
                </div>

                <div class="stat-box staffs-box">
                    <span class="emoji">üëî</span>
                    <div class="stat-content">
                        <span class="stat-number">{{ total_staffs }}</span>
                        <span class="stat-label">Total Staffs</span>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    {% if user.role == 'admin' or user.role == 'staff' %}
    <div class="chart-container">
        <h2 class="chart-heading">Task Status Breakdown</h2>
        <canvas id="taskStatusChart"></canvas>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_css %}
<style>
    body {
        background-image: url('{% static "images/bd.jpg" %}');
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        background-repeat: no-repeat;
        font-family: 'Arial', sans-serif;
    }

    .page-container {
        max-width: 1200px;
        margin: 40px auto;
        padding: 20px;
        background-color: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        box-sizing: border-box;
    }

    .greeting-message-container {
        text-align: center;
        margin-bottom: 40px;
        padding-bottom: 20px;
        border-bottom: 1px solid #e0e0e0;
    }

    .greeting-heading {
        font-size: 2.5rem;
        font-weight: bold;
        color: #1a237e;
        margin-bottom: 5px;
    }

    .greeting-subheading {
        font-size: 1.2rem;
        color: #616161;
    }
    
    .stat-container {
        margin-top: 30px;
    }
    .stats-heading {
        font-size: 1.8rem;
        font-weight: bold;
        color: #37474f;
        margin-bottom: 25px;
        text-align: center;
    }

    .flex-boxes-wrapper {
        display: flex;
        flex-wrap: wrap;
        gap: 25px;
        justify-content: center;
    }

    .stat-box {
        flex: 1 1 280px;
        padding: 30px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        min-height: 150px;
        box-sizing: border-box;
    }

    .stat-box:hover {
        transform: translateY(-8px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    }

    .stat-box .emoji {
        font-size: 3rem;
        flex-shrink: 0;
    }

    .stat-content {
        display: flex;
        flex-direction: column;
        text-align: left;
        flex-grow: 1;
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
    }

    .stat-label {
        font-size: 1rem;
        color: #757575;
        margin-top: 5px;
    }

    /* Specific box colors */
    .tasks-box {
        background-color: #f1f8e9;
        border: 2px solid #c8e6c9;
    }

    .tasks-box .stat-number {
        color: #689f38;
    }

    .all-users-box {
        background-color: #e3f2fd;
        border: 2px solid #90caf9;
    }

    .all-users-box .stat-number {
        color: #1e88e5;
    }

    .clients-box {
        background-color: #e8f5e9;
        border: 2px solid #a5d6a7;
    }

    .clients-box .stat-number {
        color: #43a047;
    }

    .staffs-box {
        background-color: #fce4ec;
        border: 2px solid #f48fb1;
    }

    .staffs-box .stat-number {
        color: #d81b60;
    }

    /* Chart styles */
    .chart-container {
        margin-top: 50px;
        padding: 20px; /* Reduced padding for a smaller box */
        background-color: #fff;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        /* Set a fixed size and center the container */
        width: 350px;
        height: 370px;
        margin-left: auto;
        margin-right: auto;
        /* Use flexbox for internal alignment */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .chart-heading {
        font-size: 1.2rem; /* Reduced font size for the heading */
        font-weight: bold;
        color: #37474f;
        margin-bottom: 10px; /* Reduced margin */
        text-align: center;
    }

    /* This rule ensures the canvas fits the new fixed-size container */
    .chart-container canvas {
        width: 100% !important;
        height: 100% !important;
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
        .page-container {
            margin: 20px auto;
            padding: 15px;
        }

        .greeting-heading {
            font-size: 2rem;
        }

        .greeting-subheading {
            font-size: 1rem;
        }

        .flex-boxes-wrapper {
            flex-direction: column;
            align-items: center;
        }

        .stat-box {
            width: 100%;
            max-width: 350px;
            padding: 25px;
            min-height: 130px;
        }

        .stat-box .emoji {
            font-size: 2.5rem;
        }

        .stat-number {
            font-size: 2rem;
        }

        /* Adjust chart container for mobile */
        .chart-container {
            width: 90%; /* Use a percentage for mobile to be more flexible */
            height: auto;
            min-height: 300px;
            padding: 15px;
        }
    }

    @media (max-width: 480px) {
        .stat-box {
            flex-direction: column;
            text-align: center;
            gap: 15px;
        }

        .stat-content {
            text-align: center;
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Ensure the chart container exists before trying to render
        const chartElement = document.getElementById('taskStatusChart');
        if (!chartElement) {
            console.warn("Chart container not found. This is expected if the user is a client.");
            return;
        }
        
        const statusData = {{ status_data_json|safe }};
        
        // Log the data for debugging
        console.log("Task data for chart:", statusData);
        
        const labels = Object.keys(statusData);
        const data = Object.values(statusData);
        
        // Hide the chart if there is no data
        if (labels.length === 0) {
            const chartContainer = chartElement.closest('.chart-container');
            if (chartContainer) {
                chartContainer.style.display = 'none';
            }
            return;
        }

        const backgroundColors = labels.map(label => {
            switch(label) {
                case 'Pending':
                    return '#ffc107'; // Yellow
                case 'In Progress':
                    return '#17a2b8'; // Cyan
                case 'Completed':
                    return '#28a745'; // Green
                case 'Canceled':
                    return '#dc3545'; // Red
                default:
                    return '#6c757d'; // Gray
            }
        });
        
        new Chart(chartElement, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Number of Tasks',
                    data: data,
                    backgroundColor: backgroundColors,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: false,
                        text: 'Task Status Breakdown'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed;
                                const total = context.dataset.data.reduce((acc, curr) => acc + curr, 0);
                                const percentage = ((value / total) * 100).toFixed(2);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %}