{% extends 'base.html' %}

{% block title %}Attendance Dashboard - Admin{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Admin Dashboard</h1>
        <div class="d-flex">
            <a href="{% url 'attendance:admin_leave_requests' %}" class="btn btn-primary mr-2">
                <i class="fas fa-clipboard-list mr-1"></i> Manage Leave Requests
            </a>
            <a href="{% url 'attendance:admin_manage_holidays' %}" class="btn btn-info">
                <i class="fas fa-calendar-alt mr-1"></i> Manage Holidays
            </a>
        </div>
    </div>

    <!-- Error Alert -->
    {% if error %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-triangle mr-2"></i>
        <strong>Database Error:</strong> {{ error }}
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    </div>
    {% endif %}

    <div class="row">
        <!-- Staff Count Card -->
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                Total Staff</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ total_staff }} Active Staff
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-users fa-2x text-gray-300"></i>
                        </div>
                    </div>
                    <hr>
                    <div class="text-center">
                        <a href="{% url 'attendance:all_staff_attendance' %}" class="btn btn-outline-primary btn-block btn-sm">
                            <i class="fas fa-list mr-1"></i> View Staff List
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Today's Summary Card -->
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Today's Summary</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {% if today_attendance_count %}
                                    {{ today_attendance_count }} record{{ today_attendance_count|pluralize }}
                                {% else %}
                                    No records yet
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-calendar-day fa-2x text-gray-300"></i>
                        </div>
                    </div>
                    <hr>
                    <div class="text-center">
                        {% if today_attendance_count %}
                            <a href="{% url 'attendance:all_staff_attendance' %}" class="btn btn-sm btn-outline-success">
                                <i class="fas fa-arrow-right mr-1"></i> View Details
                            </a>
                        {% else %}
                            <span class="text-muted small">No attendance recorded yet</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Pending Requests Card -->
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                Pending Leave Requests</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                {{ pending_requests|length }} Request{{ pending_requests|length|pluralize }}
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                        </div>
                    </div>
                    <hr>
                    <div class="text-center">
                        {% if pending_requests %}
                            <a href="{% url 'attendance:admin_leave_requests' %}" class="btn btn-sm btn-outline-warning">
                                <i class="fas fa-tasks mr-1"></i> Review Requests
                            </a>
                        {% else %}
                            <span class="text-muted small">No pending requests</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Second Row - Additional Stats -->
    <div class="row">
        <!-- Weekly Attendance Summary -->
        <div class="col-xl-6 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-info">
                        <i class="fas fa-chart-bar mr-1"></i> Weekly Attendance Overview
                    </h6>
                </div>
                <div class="card-body">
                    {% if staff_attendance %}
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Staff Member</th>
                                        <th class="text-center">Present Days</th>
                                        <th class="text-center">Last Activity</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for staff_data in staff_attendance %}
                                    <tr>
                                        <td>
                                            <strong>{{ staff_data.staff.get_full_name|default:staff_data.staff.email }}</strong>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge {% if staff_data.present_days > 0 %}badge-success{% else %}badge-secondary{% endif %}">
                                                {{ staff_data.present_days }}/{{ staff_data.total_days }}
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            {% if staff_data.last_check_in %}
                                                <small class="text-muted">
                                                    {{ staff_data.last_check_in.timestamp|date:"M d, H:i" }}
                                                </small>
                                            {% else %}
                                                <span class="text-muted">No activity</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-users fa-2x mb-2"></i>
                            <p>No attendance data available for this week</p>
                        </div>
                    {% endif %}
                </div>
                <div class="card-footer">
                    <a href="{% url 'attendance:all_staff_attendance' %}" class="btn btn-sm btn-outline-info btn-block">
                        <i class="fas fa-chart-line mr-1"></i> View Detailed Reports
                    </a>
                </div>
            </div>
        </div>

        <!-- Recent Check-ins Card -->
        <div class="col-xl-6 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-success">
                        <i class="fas fa-clock mr-1"></i> Recent Check-ins Today
                    </h6>
                    <span class="badge badge-success badge-pill">{{ recent_checkins|length }}</span>
                </div>
                <div class="card-body">
                    {% if recent_checkins %}
                        <div class="list-group list-group-flush">
                            {% for checkin in recent_checkins %}
                            <div class="list-group-item d-flex justify-content-between align-items-center px-0 py-2">
                                <div>
                                    <strong>{{ checkin.user.get_full_name|default:checkin.user.email }}</strong>
                                    <br>
                                    <small class="text-muted">
                                        <i class="fas fa-clock mr-1"></i>
                                        {{ checkin.timestamp|time:"H:i" }}
                                    </small>
                                </div>
                                <span class="badge badge-success badge-pill">
                                    <i class="fas fa-check"></i>
                                </span>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-user-clock fa-2x mb-2"></i>
                            <p>No check-ins recorded yet today</p>
                        </div>
                    {% endif %}
                </div>
                <div class="card-footer">
                    <a href="{% url 'attendance:all_staff_attendance' %}" class="btn btn-sm btn-outline-success btn-block">
                        <i class="fas fa-list mr-1"></i> View All Attendance
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Today's Activity -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-primary">
                <i class="fas fa-calendar-day mr-2"></i>Today's Activity
            </h6>
            <div>
                <span class="badge badge-success mr-2">Present</span>
                <span class="badge badge-warning mr-2">Late</span>
                <span class="badge badge-danger">Absent</span>
            </div>
        </div>
        <div class="card-body">
            {% if recent_checkins %}
                <div class="table-responsive">
                    <table class="table table-bordered" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>Staff</th>
                                <th>Check-in Time</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for checkin in recent_checkins %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="symbol symbol-40 symbol-light-{{ forloop.counter|divisibleby:2|yesno:'success,info' }} mr-3">
                                            <span class="symbol-label font-size-h5">
                                                {{ checkin.user.first_name|first|upper }}{{ checkin.user.last_name|first|upper }}
                                            </span>
                                        </div>
                                        <div>
                                            <div class="font-weight-bold">{{ checkin.user.get_full_name|default:checkin.user.email }}</div>
                                            <div class="text-muted small">{{ checkin.user.email }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>{{ checkin.timestamp|date:"M j, Y H:i" }}</td>
                                <td>
                                    {% if checkin.attendance_type == 'check_in' %}
                                        <span class="badge badge-success">Checked In</span>
                                    {% else %}
                                        <span class="badge badge-danger">Checked Out</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{% url 'attendance:staff_attendance_history' user_id=checkin.user.id %}"
                                       class="btn btn-sm btn-primary"
                                       data-toggle="tooltip"
                                       title="View full history">
                                        <i class="fas fa-history"></i> History
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info text-center py-4">
                    <i class="fas fa-info-circle fa-2x mb-3"></i>
                    <h5>No attendance records found for today</h5>
                    <p class="mb-0">Staff members haven't checked in yet today.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Pending Leave Requests Section -->
    <div class="card shadow mb-4">
        <div class="card-header py-3 d-flex justify-content-between align-items-center">
            <h6 class="m-0 font-weight-bold text-warning">
                <i class="fas fa-exclamation-circle mr-2"></i> Pending Leave Requests
            </h6>
            <span class="badge badge-warning badge-pill">{{ pending_requests|length }}</span>
        </div>
        <div class="card-body">
            {% if pending_requests %}
                <div class="table-responsive">
                    <table class="table table-bordered" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>Staff Member</th>
                                <th>Leave Type</th>
                                <th>Date Range</th>
                                <th>Requested</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for request in pending_requests %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="symbol symbol-40 symbol-light-warning mr-3">
                                            <span class="symbol-label font-size-h5">
                                                {{ request.user.first_name|first|upper }}{{ request.user.last_name|first|upper }}
                                            </span>
                                        </div>
                                        <div>
                                            <div class="font-weight-bold">{{ request.user.get_full_name|default:request.user.email }}</div>
                                            <div class="text-muted small">{{ request.user.email }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge badge-info">{{ request.leave_type }}</span>
                                </td>
                                <td>
                                    {{ request.start_date|date:"M d, Y" }} - {{ request.end_date|date:"M d, Y" }}
                                    <br>
                                    <small class="text-muted">
                                        ({{ request.duration_days }} day{{ request.duration_days|pluralize }})
                                    </small>
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {{ request.created_at|timesince }} ago
                                    </small>
                                </td>
                                <td>
                                    <a href="{% url 'attendance:manage_leave' request.id %}"
                                       class="btn btn-sm btn-warning"
                                       data-toggle="tooltip"
                                       title="Review this request">
                                        <i class="fas fa-clipboard-check"></i> Review
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-success text-center py-4">
                    <i class="fas fa-check-circle fa-2x mb-3"></i>
                    <h5>No Pending Leave Requests</h5>
                    <p class="mb-0">All leave requests have been processed.</p>
                </div>
            {% endif %}
        </div>
        <div class="card-footer text-center">
            <a href="{% url 'attendance:admin_leave_requests' %}" class="btn btn-primary">
                <i class="fas fa-clipboard-list mr-1"></i> Manage All Leave Requests
            </a>
        </div>
    </div>

    <!-- Holidays Section -->
    <div class="row">
        <!-- Upcoming Holidays -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header py-3 d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-success">
                        <i class="fas fa-gift mr-2"></i> Upcoming Holidays
                    </h6>
                    {% if user.is_superuser %}
                    <a href="{% url 'attendance:admin_add_holiday' %}" class="btn btn-sm btn-success">
                        <i class="fas fa-plus fa-sm"></i> Add Holiday
                    </a>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if upcoming_holidays %}
                        <div class="list-group list-group-flush">
                            {% for holiday in upcoming_holidays %}
                            <div class="list-group-item d-flex justify-content-between align-items-center px-0 py-3">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1 font-weight-bold text-dark">{{ holiday.name }}</h6>
                                    <p class="mb-1 text-muted">
                                        <i class="fas fa-calendar mr-1"></i>
                                        {{ holiday.date|date:"l, F d, Y" }}
                                    </p>
                                    <small class="text-info">
                                        <i class="fas fa-clock mr-1"></i>
                                        {{ holiday.date|timeuntil }} from now
                                    </small>
                                </div>
                                <div class="text-right">
                                    <span class="badge badge-success badge-pill">{{ holiday.date|date:"M d" }}</span>
                                    {% if user.is_superuser %}
                                    <div class="mt-2">
                                        <a href="{% url 'attendance:admin_edit_holiday' holiday.id %}" class="btn btn-sm btn-info" title="Edit">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="{% url 'attendance:admin_delete_holiday' holiday.id %}" class="btn btn-sm btn-danger" title="Delete" onclick="return confirm('Are you sure you want to delete this holiday?')">
                                            <i class="fas fa-trash"></i>
                                        </a>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-calendar-plus fa-2x mb-3"></i>
                            <h5>No Upcoming Holidays</h5>
                            <p class="mb-0">Add holidays to help with leave planning.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Recent Holidays -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow h-100">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-secondary">
                        <i class="fas fa-history mr-2"></i> Recent Holidays
                    </h6>
                </div>
                <div class="card-body">
                    {% if past_holidays %}
                        <div class="list-group list-group-flush">
                            {% for holiday in past_holidays %}
                            <div class="list-group-item d-flex justify-content-between align-items-center px-0 py-3">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1 font-weight-bold text-dark">{{ holiday.name }}</h6>
                                    <p class="mb-1 text-muted">
                                        <i class="fas fa-calendar mr-1"></i>
                                        {{ holiday.date|date:"l, F d, Y" }}
                                    </p>
                                    <small class="text-muted">
                                        <i class="fas fa-clock mr-1"></i>
                                        {{ holiday.date|timesince }} ago
                                    </small>
                                </div>
                                <span class="badge badge-secondary badge-pill">{{ holiday.date|date:"M d" }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-calendar-minus fa-2x mb-3"></i>
                            <h5>No Recent Holidays</h5>
                            <p class="mb-0">Past holidays will appear here.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-bolt mr-1"></i> Quick Actions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3 mb-3">
                            <a href="{% url 'attendance:admin_attendance_report' %}" class="btn btn-outline-primary btn-block py-3">
                                <i class="fas fa-chart-line fa-2x mb-2"></i><br>
                                Attendance Reports
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="{% url 'attendance:all_staff_attendance' %}" class="btn btn-outline-info btn-block py-3">
                                <i class="fas fa-list-alt fa-2x mb-2"></i><br>
                                Staff Attendance
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="{% url 'attendance:admin_leave_requests' %}" class="btn btn-outline-warning btn-block py-3">
                                <i class="fas fa-clipboard-check fa-2x mb-2"></i><br>
                                Leave Management
                            </a>
                        </div>
                        <div class="col-md-3 mb-3">
                            <a href="{% url 'attendance:admin_manage_holidays' %}" class="btn btn-outline-success btn-block py-3">
                                <i class="fas fa-calendar-plus fa-2x mb-2"></i><br>
                                Holiday Setup
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Spinner (hidden by default) -->
<div id="loadingSpinner" class="d-none">
    <div class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Loading...</span>
        </div>
        <p class="mt-2 text-muted">Loading dashboard data...</p>
    </div>
</div>

<style>
.card {
    transition: transform 0.2s ease-in-out;
}
.card:hover {
    transform: translateY(-2px);
}
.list-group-item {
    border: none;
    border-bottom: 1px solid #eee;
}
.list-group-item:last-child {
    border-bottom: none;
}
.badge {
    font-size: 0.7rem;
}
.btn-block {
    white-space: nowrap;
}
.symbol {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border-radius: 50%;
}
.symbol-light-success {
    background-color: #e8f5e8;
}
.symbol-light-info {
    background-color: #e3f2fd;
}
.symbol-light-warning {
    background-color: #fff3cd;
}
.symbol-label {
    font-weight: bold;
    color: #333;
}
</style>

<script>
// Simple loading indicator
document.addEventListener('DOMContentLoaded', function() {
    const links = document.querySelectorAll('a.btn');
    links.forEach(link => {
        link.addEventListener('click', function() {
            const spinner = document.getElementById('loadingSpinner');
            if (spinner) {
                spinner.classList.remove('d-none');
            }
        });
    });

    // Hide spinner when page is fully loaded
    window.addEventListener('load', function() {
        const spinner = document.getElementById('loadingSpinner');
        if (spinner) {
            spinner.classList.add('d-none');
        }
    });

    // Initialize tooltips
    $('[data-toggle="tooltip"]').tooltip();
});
</script>
{% endblock %}